var canvas,nameObject,addressObject,brailleObject,frameObject,modeOfOperationObject,modeOfOperationDetailsObject,horizontalLineObject,fontsArr={},currentScale=2,isCanvasInitialized=!1;const SIZES={"400x300":{width:1e3,height:750},"500x400":{width:1250,height:1e3},"600x400":{width:1500,height:1e3}};var currentSize="600x400",realWidth=SIZES[currentSize].width,realHeight=SIZES[currentSize].height;const NAME_FONT_RATIO=.105,ADDRESS_FONT_RATIO=.05,BRAILLE_FIXED_FONT_SIZE=24,TEXT_PADDING_PERCENT=.055,MIN_FONT_SIZE=10,MODE_OF_OPERATION_FONT_RATIO=.065,MODE_OF_OPERATION_DETAILS_FONT_RATIO=.05,HORIZONTAL_LINE_COLOR="#1d1d1b",HORIZONTAL_LINE_STROKE_FACTOR=.0075;function debounce(e,t){let i;return function(...n){let a=this;clearTimeout(i),i=setTimeout(()=>e.apply(a,n),t)}}function autoGrowTextarea(e){e.style.height="auto",e.style.height=e.scrollHeight+"px"}function updateCanvasScale(){isCanvasInitialized&&(currentScale=$("#canvas-container").width()/realWidth,$("#canvas-container").css({height:realHeight*currentScale+"px"}),$(".canvas-container").css({transform:"scale("+currentScale+")","transform-origin":"0 0"}),canvas.setDimensions({width:realWidth,height:realHeight}),nameObject&&(nameObject.set("fontSize",.105*realHeight),adjustNameSize(nameObject)),modeOfOperationObject&&(modeOfOperationObject.set("fontSize",.065*realHeight),adjustModeOfOperationText(modeOfOperationObject)),modeOfOperationDetailsObject&&(modeOfOperationDetailsObject.set("fontSize",.05*realHeight),adjustModeOfOperationDetailsText(modeOfOperationDetailsObject)),addressObject&&(addressObject.set("fontSize",.05*realHeight),adjustAddressSize(addressObject)),brailleObject&&updateBrailleText(),updateAllObjectPositions(),canvas.renderAll())}function loadAndPositionBackground(){var e=new fabric.Rect({width:realWidth,height:realHeight,fill:"#ffec00",selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0}),t=.02*Math.min(realWidth,realHeight);frameObject=new fabric.Rect({width:realWidth-2.5*t,height:realHeight-2.5*t,fill:"transparent",stroke:"#1d1d1b",strokeWidth:.015*Math.min(realWidth,realHeight),rx:.01*Math.min(realWidth,realHeight),ry:.01*Math.min(realWidth,realHeight),left:realWidth/2,top:realHeight/2,originX:"center",originY:"center",selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0}),canvas.add(e),canvas.add(frameObject),canvas.sendToBack(e),canvas.renderAll(),updateCanvasScale()}function adjustNameSize(e){let t=.89*realWidth-2,i=.34754999999999997*realHeight,n=MIN_FONT_SIZE,a=.105*realHeight,o=n=>{e.set({fontSize:n,width:t,splitByGrapheme:!1,breakWords:!1,lineHeight:1.1,ellipsis:!0},{silent:!0}),e.initDimensions();let a=e._textLines?e._textLines.length:0,o=e.height;return!(a>3)&&!(o>i)&&!(e.width>t+.01)},l=n,r=a,d=n;for(;r-l>.01;){let s=(l+r)/2;o(s)?(d=s,l=s):r=s}for(;!o(d)&&d>n;)if((d-=.01)<n){d=n;break}d=Math.min(d,a),e.set({fontSize:d,left:realWidth/2,originX:"center",originY:"top",width:t,lineHeight:1.1,splitByGrapheme:!1,breakWords:!1,ellipsis:!0})}function adjustAddressSize(e){let t=.89*realWidth-2,i=.0505*realHeight,n=MIN_FONT_SIZE,a=.05*realHeight,o=n=>{e.set({fontSize:n,width:t,splitByGrapheme:!0,breakWords:!0,lineHeight:1,noWrap:!1},{silent:!0}),e.initDimensions();let a=e._textLines?e._textLines.length:0,o=e.height;if(a>1||o>i)return!1;if(e.__charBounds&&a>0){let l=0;for(let r=0;r<a;r++){let d=e.__charBounds[r];if(d&&d.length>0){let s=d[0].left,c=d[d.length-1],h=c.left+c.width-s;h>l&&(l=h)}}if(l>t)return!1}return!0},l=n,r=a,d=n;for(;r-l>.01;){let s=(l+r)/2;o(s)?(d=s,l=s):r=s}for(;!o(d)&&d>n;)if((d-=.01)<n){d=n;break}d=Math.min(d,a),e.set({fontSize:d,left:realWidth/2,originX:"center",width:t,lineHeight:1,noWrap:!1})}function adjustModeOfOperationText(e){let t=.89*realWidth-2,i=.065*realHeight;e.set({fontSize:i,width:t,splitByGrapheme:!1,breakWords:!1,lineHeight:1,ellipsis:!0,noWrap:!1},{silent:!0}),e.initDimensions();let n=i;for(;e.width>t+.01&&n>MIN_FONT_SIZE;)n-=1,e.set("fontSize",n,{silent:!0}),e.initDimensions();e.set({fontSize:n,left:realWidth/2,originX:"center",originY:"top",width:t,lineHeight:1})}function adjustModeOfOperationDetailsText(e){let t=.89*realWidth-2,i=.1655*realHeight,n=MIN_FONT_SIZE,a=.05*realHeight,o=n=>{e.set({fontSize:n,width:t,splitByGrapheme:!1,breakWords:!1,lineHeight:1.1,ellipsis:!0},{silent:!0}),e.initDimensions();let a=e._textLines?e._textLines.length:0,o=e.height;return!(a>3)&&!(o>i)&&!(e.width>t+.01)},l=n,r=a,d=n;for(;r-l>.01;){let s=(l+r)/2;o(s)?(d=s,l=s):r=s}for(;!o(d)&&d>n;)if((d-=.01)<n){d=n;break}d=Math.min(d,a),e.set({fontSize:d,left:realWidth/2,originX:"center",originY:"top",width:t,lineHeight:1.1})}function brailleTranslator(e){let t={А:"a",Б:"b",В:"v",Г:"g",Д:"d",Е:"e",Ё:"e",Ж:"j",З:"z",И:"i",Й:"y",К:"k",Л:"l",М:"m",Н:"n",О:"o",П:"p",Р:"r",С:"s",Т:"t",У:"u",Ф:"f",Х:"h",Ц:"c",Ч:"c",Ш:"s",Щ:"s",Ъ:"x",Ы:"w",Ь:"j",Э:"e",Ю:"u",Я:"r",1:"#a",2:"#b",3:"#c",4:"#d",5:"#e",6:"#f",7:"#g",8:"#h",9:"#i",0:"#j",".":".",",":",","-":"-","?":"?","!":"!"," ":" ","\n":"\n"},i="";for(let n=0;n<e.length;n++){let a=e[n].toUpperCase();void 0!==t[a]&&(i+=t[a])}return i}function updateName(){let e=$("#name-edit").val(),t=e.split("\n");if(t.length>3){let i=document.getElementById("name-edit").selectionStart,n=document.getElementById("name-edit").selectionEnd,a=t.slice(0,3).join("\n");$("#name-edit").val(a),i>a.length?document.getElementById("name-edit").selectionStart=document.getElementById("name-edit").selectionEnd=a.length:(document.getElementById("name-edit").selectionStart=i,document.getElementById("name-edit").selectionEnd=n)}nameObject&&void 0!==e&&(nameObject.set({text:e.toUpperCase()}),adjustNameSize(nameObject)),updateAllObjectPositions(),updateBrailleText(),canvas.renderAll()}function updateModeOfOperationDetails(){let e=$("#mode-of-operation-details-edit").val(),t=e.split("\n");if(t.length>3){let i=document.getElementById("mode-of-operation-details-edit").selectionStart,n=document.getElementById("mode-of-operation-details-edit").selectionEnd,a=t.slice(0,3).join("\n");$(this).val(a),i>a.length?this.selectionStart=this.selectionEnd=a.length:(this.selectionStart=i,this.selectionEnd=n)}modeOfOperationDetailsObject&&void 0!==e&&(modeOfOperationDetailsObject.set({text:e.toUpperCase()}),adjustModeOfOperationDetailsText(modeOfOperationDetailsObject)),updateAllObjectPositions(),updateBrailleText(),canvas.renderAll()}function updateAddress(){let e=$("#address-edit").val();e=e.split("\n")[0],addressObject&&void 0!==e&&(addressObject.set({text:e.toUpperCase(),lineHeight:1}),adjustAddressSize(addressObject)),updateAllObjectPositions(),updateBrailleText(),canvas.renderAll()}function updateBrailleText(){let e=$("#name-edit").val(),t=$("#address-edit").val(),i=$("#mode-of-operation-details-edit").val(),n=[],a=e.replace(/\n/g," ").trim();a&&n.push(a);let o=i.replace(/\n/g," ").trim();o&&n.push(o);let l=t.trim();l&&n.push(l);let r=n.join("\n"),d=brailleTranslator(r);brailleObject&&void 0!==d&&(brailleObject.set({text:d.toUpperCase(),fontSize:24,width:.89*realWidth-2,splitByGrapheme:!1,breakWords:!1,ellipsis:!1,lineHeight:1.35,originY:"top"}),brailleObject.initDimensions())}function updateAllObjectPositions(){if(!nameObject||!modeOfOperationObject||!modeOfOperationDetailsObject||!addressObject||!brailleObject||!horizontalLineObject)return;nameObject.initDimensions(),modeOfOperationObject.initDimensions(),modeOfOperationDetailsObject.initDimensions(),addressObject.initDimensions(),brailleObject.initDimensions();let e=nameObject.height+modeOfOperationObject.height+modeOfOperationDetailsObject.height+addressObject.height+brailleObject.height+.0075*Math.min(realWidth,realHeight),t=(realHeight-e)/7,i=t;nameObject.set({top:i,originY:"top",left:realWidth/2,originX:"center"}),i+=nameObject.height+t,modeOfOperationObject.set({top:i,originY:"top",left:realWidth/2,originX:"center"}),i+=modeOfOperationObject.height+t,modeOfOperationDetailsObject.set({top:i,originY:"top",left:realWidth/2,originX:"center"}),i+=modeOfOperationDetailsObject.height+t,addressObject.set({top:i,originY:"top",left:realWidth/2,originX:"center"}),i+=addressObject.height+t;let n=.0075*Math.min(realWidth,realHeight),a=i+n/2,o=.89*realWidth-2,l=realWidth/2-o/2,r=realWidth/2+o/2;horizontalLineObject.set({x1:l,y1:a,x2:r,y2:a,strokeWidth:n}),i+=n+t,brailleObject.set({top:i,originY:"top",left:realWidth/2,originX:"center"})}function changeSize(){realWidth=SIZES[currentSize=$("#size-select").val()].width,realHeight=SIZES[currentSize].height,canvas.setDimensions({width:realWidth,height:realHeight});var e=[];canvas.getObjects().forEach(t=>{(t instanceof fabric.Rect&&"#ffec00"===t.fill||t instanceof fabric.Rect&&"#1d1d1b"===t.stroke)&&e.push(t)}),e.forEach(e=>{canvas.remove(e)}),loadAndPositionBackground(),nameObject&&(nameObject.set({left:realWidth/2,top:0,fontSize:.105*realHeight,width:.89*realWidth-2}),adjustNameSize(nameObject)),modeOfOperationObject&&(modeOfOperationObject.set("fontSize",.065*realHeight),adjustModeOfOperationText(modeOfOperationObject)),modeOfOperationDetailsObject&&(modeOfOperationDetailsObject.set("fontSize",.05*realHeight),adjustModeOfOperationDetailsText(modeOfOperationDetailsObject)),addressObject&&(addressObject.set({left:realWidth/2,fontSize:.05*realHeight,noWrap:!1,splitByGrapheme:!0,breakWords:!0,width:.89*realWidth-2}),adjustAddressSize(addressObject)),brailleObject&&(brailleObject.set("fontSize",24),updateBrailleText()),updateAllObjectPositions(),canvas.renderAll()}function downloadSVG(){canvas.bringToFront(nameObject),canvas.bringToFront(modeOfOperationObject),canvas.bringToFront(modeOfOperationDetailsObject),canvas.bringToFront(addressObject),canvas.bringToFront(horizontalLineObject),canvas.bringToFront(brailleObject),canvas.renderAll();let e={originX:nameObject.originX,originY:nameObject.originY,left:nameObject.left,top:nameObject.top},t={originX:modeOfOperationObject.originX,originY:modeOfOperationObject.originY,left:modeOfOperationObject.left,top:modeOfOperationObject.top,width:modeOfOperationObject.width},i={originX:modeOfOperationDetailsObject.originX,originY:modeOfOperationDetailsObject.originY,left:modeOfOperationDetailsObject.left,top:modeOfOperationDetailsObject.top,width:modeOfOperationDetailsObject.width},n={originX:addressObject.originX,originY:addressObject.originY,left:addressObject.left,top:addressObject.top,width:addressObject.width},a={originX:brailleObject.originX,originY:brailleObject.originY,left:brailleObject.left,top:brailleObject.top,width:brailleObject.width},o={x1:horizontalLineObject.x1,y1:horizontalLineObject.y1,x2:horizontalLineObject.x2,y2:horizontalLineObject.y2,strokeWidth:horizontalLineObject.strokeWidth};nameObject.set({originX:"left",originY:"top",left:e.left-nameObject.width*("center"===e.originX?.5:0),top:e.top-nameObject.height*(e.originY,0)});let l=.89*realWidth-2;modeOfOperationObject.set({originX:"left",originY:"top",width:l,left:t.left-l*("center"===t.originX?.5:0),top:t.top-modeOfOperationObject.height*(t.originY,0)});let r=.89*realWidth-2;modeOfOperationDetailsObject.set({originX:"left",originY:"top",width:r,left:i.left-r*("center"===i.originX?.5:0),top:i.top-modeOfOperationDetailsObject.height*(i.originY,0)});let d=.89*realWidth-2;addressObject.set({originX:"left",originY:"top",width:d,left:n.left-d*("center"===n.originX?.5:0),top:n.top-addressObject.height*(n.originY,0)}),horizontalLineObject.set({x1:o.x1,y1:o.y1,x2:o.x2,y2:o.y2});let s=.89*realWidth-2;brailleObject.set({originX:"left",originY:"top",width:s,left:a.left-s*("center"===a.originX?.5:0),top:a.top-brailleObject.height*(a.originY,0)}),canvas.renderAll();var c=canvas.toSVG({suppressPreamble:!0,viewBox:{x:0,y:0,width:realWidth,height:realHeight},width:.4*realWidth+"mm",height:.4*realHeight+"mm"});nameObject.set(e),modeOfOperationObject.set(t),modeOfOperationDetailsObject.set(i),addressObject.set(n),horizontalLineObject.set(o),brailleObject.set(a),canvas.renderAll();var h=new Blob([c],{type:"image/svg+xml;charset=utf-8"}),O=URL.createObjectURL(h);let f=$("#name-edit").val().toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");var p=document.createElement("a");p.href=O,p.download=`Табличка ${f} (${currentSize.replace("x","\xd7")} мм).svg`,document.body.appendChild(p),p.click(),setTimeout(function(){document.body.removeChild(p),window.URL.revokeObjectURL(O)},100),alert("SVG скачан с текстом в кривых.")}$(document).ready(function(){document.body.classList.remove("loaded");var e=[];e.push(new Promise((e,t)=>{opentype.load("/braille/fonts/STIXTwoText-Bold.woff",function(i,n){i?(console.error("Error loading STIXTwoText-Bold font:",i),t(i)):(fontsArr["als-bold"]={obj:n,name:"als-bold"},e())})})),e.push(new Promise((e,t)=>{opentype.load("/braille/fonts/STIXTwoText-Medium.woff",function(i,n){i?(console.error("Error loading STIXTwoText-Medium font:",i),t(i)):(fontsArr["als-medium"]={obj:n,name:"als-medium"},e())})})),e.push(new Promise((e,t)=>{opentype.load("/braille/fonts/astakhovbraillealpha.woff",function(i,n){i?(console.error("Error loading SimBraille font:",i),t(i)):(fontsArr.SimBraille={obj:n,name:"SimBraille"},e())})})),Promise.all(e).then(()=>{console.log("All opentype fonts loaded."),canvas=new fabric.Canvas("c",{width:realWidth,height:realHeight,preserveObjectStacking:!0,selection:!1,fireRightClick:!0,stopContextMenu:!0,allowTouchScrolling:!0,skipTargetFind:!0,enableRetinaScaling:!0}),document.getElementById("c").addEventListener("touchmove",function(e){canvas.findTarget(e)||e.stopPropagation()},{passive:!0}),nameObject=new fabric.CurvesText('ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ ОБРАЗОВАТЕЛЬНОЕ УЧРЕЖДЕНИЕ ВЫСШЕГО ОБРАЗОВАНИЯ "СЕВЕРНЫЙ (АРКТИЧЕСКИЙ) ФЕДЕРАЛЬНЫЙ УНИВЕРСИТЕТ ИМЕНИ М.В. ЛОМОНОСОВА"',{fontFamily:"als-bold",width:.89*realWidth-2,left:realWidth/2,top:0,originX:"center",originY:"top",textAlign:"center",fill:"#1d1d1b",fontSize:.105*realHeight,lineHeight:1.1,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,textBackgroundColor:"transparent",splitByGrapheme:!1,breakWords:!1,ellipsis:!0,fontVariant:"normal"}),modeOfOperationObject=new fabric.CurvesText("РЕЖИМ РАБОТЫ",{fontFamily:"als-bold",width:.89*realWidth-2,left:realWidth/2,top:0,originX:"center",originY:"top",textAlign:"center",fill:"#1d1d1b",fontSize:.065*realHeight,lineHeight:1,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,textBackgroundColor:"transparent",splitByGrapheme:!1,breakWords:!1,ellipsis:!0,fontVariant:"normal"}),modeOfOperationDetailsObject=new fabric.CurvesText("ПОНЕДЕЛЬНИК-ПЯТНИЦА: 8:30–18:00\nСУББОТА: 8:30–16:00\nВОСКРЕСЕНЬЕ: ВЫХОДНОЙ",{fontFamily:"als-bold",width:.89*realWidth-2,left:realWidth/2,top:0,originX:"center",originY:"top",textAlign:"center",fill:"#1d1d1b",fontSize:.05*realHeight,lineHeight:1.1,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,textBackgroundColor:"transparent",splitByGrapheme:!1,breakWords:!1,ellipsis:!0,fontVariant:"normal"}),addressObject=new fabric.CurvesText("163002, Архангельская область, город Архангельск, наб. Северной Двины, д.17",{fontFamily:"als-bold",left:realWidth/2,top:0,originX:"center",originY:"top",textAlign:"center",fill:"#1d1d1b",fontSize:.05*realHeight,lineHeight:1,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,noWrap:!1,splitByGrapheme:!0,breakWords:!0,width:.89*realWidth-2,textBackgroundColor:"transparent",fontVariant:"normal"}),brailleObject=new fabric.CurvesText("БРАЙЛЬ",{fontFamily:"SimBraille",width:.89*realWidth-2,left:realWidth/2,top:0,originX:"center",originY:"top",textAlign:"left",fill:"#1d1d1b",fontSize:24,lineHeight:1.35,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,textBackgroundColor:"transparent",splitByGrapheme:!1,breakWords:!1,ellipsis:!1,fontVariant:"normal"}),horizontalLineObject=new fabric.Line([0,0,0,0],{stroke:"#1d1d1b",strokeWidth:.0075*Math.min(realWidth,realHeight),selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0}),canvas.add(nameObject),canvas.add(modeOfOperationObject),canvas.add(modeOfOperationDetailsObject),canvas.add(addressObject),canvas.add(horizontalLineObject),canvas.add(brailleObject),$("#name-edit").val(nameObject.text),$("#mode-of-operation-details-edit").val(modeOfOperationDetailsObject.text),$("#address-edit").val(addressObject.text.split("\n")[0]),isCanvasInitialized=!0,loadAndPositionBackground(),$(window).resize(updateCanvasScale);let e=debounce(function(){updateName()},150),t=debounce(function(){updateAddress()},150),i=debounce(function(){updateModeOfOperationDetails()},150);$("#name-edit").on("input",function(){let t=$(this).val().split("\n");if(t.length>3){let i=this.selectionStart,n=this.selectionEnd,a=t.slice(0,3).join("\n");$(this).val(a),i>a.length?this.selectionStart=this.selectionEnd=a.length:(this.selectionStart=i,this.selectionEnd=n)}autoGrowTextarea(this),e()}).on("keydown",function(e){"Enter"===e.key&&$(this).val().split("\n").length>=3&&e.preventDefault()}),$("#mode-of-operation-details-edit").on("input",function(){let e=$(this).val().split("\n");if(e.length>3){let t=this.selectionStart,n=this.selectionEnd,a=e.slice(0,3).join("\n");$(this).val(a),t>a.length?this.selectionStart=this.selectionEnd=a.length:(this.selectionStart=t,this.selectionEnd=n)}autoGrowTextarea(this),i()}).on("keydown",function(e){"Enter"===e.key&&$(this).val().split("\n").length>=3&&e.preventDefault()}),$("#address-edit").on("input",function(){let e=$(this).val();if(e.includes("\n")){let i=this.selectionStart;e=e.replace(/\n/g,""),$(this).val(e),this.selectionStart=this.selectionEnd=i>0?i-1:0}autoGrowTextarea(this),t()}).on("keydown",function(e){"Enter"===e.key&&e.preventDefault()}),$("#size-select").on("change",changeSize),$("#download-btn").click(downloadSVG),autoGrowTextarea(document.getElementById("name-edit")),autoGrowTextarea(document.getElementById("mode-of-operation-details-edit")),autoGrowTextarea(document.getElementById("address-edit")),updateName(),updateAddress(),updateBrailleText(),clearTimeout(loadTimeout),document.body.classList.add("loaded"),setTimeout(function(){var e=document.querySelector(".preloader");e&&e.remove()},150)}).catch(e=>{console.error("Failed to load Opentype fonts or initialize Fabric.js:",e),alert("Ошибка при загрузке шрифтов или инициализации. Проверьте консоль."),clearTimeout(loadTimeout),document.body.classList.add("loaded"),setTimeout(function(){var e=document.querySelector(".preloader");e&&e.remove()},150)})});var loadTimeout=setTimeout(function(){var e=document.querySelector(".preloader__text");e&&(e.textContent="Загрузка занимает больше времени, чем обычно...")},3e3);window.addEventListener("error",function(){clearTimeout(loadTimeout),document.body.classList.add("loaded"),setTimeout(function(){var e=document.querySelector(".preloader");e&&e.remove()},100)},!0);